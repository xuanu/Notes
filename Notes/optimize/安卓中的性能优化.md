********#  安卓中的性能优化

> 本文所指性能优化仅从两方面：内存泄露与UI卡顿。

## 内存泄露

> 推荐阅读： [Android内存泄漏分析心得](http://mp.weixin.qq.com/s?__biz=MzI1MTA1MzM2Nw==&mid=2649796884&idx=1&sn=92b4e344060362128e4a86d6132c3736&chksm=f1fcc54cc68b4c5add08371265320163381ea81333daea5664b94e9a12246a34cfaa31e6f0b3&mpshare=1&scene=1&srcid=1116PDhSmvxU6YwfbJuVCEJx#rd);

推荐文章对内存泄露的原因进行了全面总结，推荐阅读。备份一份在Github：[Android内存泄漏分析心得](https://github.com/xuanu/Notes/tree/master/Notes/web/MemoryLeak);,下载即可阅读

###  检测工具

> 推荐使用工具：[square](https://github.com/square)/**[leakcanary](https://github.com/square/leakcanary)**
>
> 简单的几行代码，让你不用再去分析Memory曲线图。支持安卓4.0以上。

##### 1.  添加依赖

> 以下代码添加成功后仅在调试模式下有用，正式发包时不影响。
>
> 建议前往原地址查看最新的集成版本号。

```java
 dependencies {
   debugCompile 'com.squareup.leakcanary:leakcanary-android:1.5.1'
   releaseCompile 'com.squareup.leakcanary:leakcanary-android-no-op:1.5.1'
   testCompile 'com.squareup.leakcanary:leakcanary-android-no-op:1.5.1'
 }
```

##### 2.  添加代码

> 在Application中添加代码

```java
public class ExampleApplication extends Application {

  @Override public void onCreate() {
    super.onCreate();
    if (LeakCanary.isInAnalyzerProcess(this)) {
      return;
    }
    LeakCanary.install(this);
  }
}
```

以上就算集成完毕了，在调试时发生内存泄露，就会在通知栏提示用户。  

![image](https://github.com/square/leakcanary/raw/master/assets/screenshot.png)  

下面用一个Demo来简单演示使用方法。

##### 3. Demo  
1. ​简单的起一个新的页面，点击的时候模拟结束当前页面，并且调用      

  ```java
                  mHandler.postDelayed(new Runnable() {
                      @Override
                      public void run() {
                      }
                  }, 10 * 1000);
                  Leak1Activity.this.finish();
  ```

2. 过一个几秒就会提示内存泄露并打开通知栏。      
  ![image](https://github.com/xuanu/Notes/raw/master/screenshots/TIM%E6%88%AA%E5%9B%BE20170718100151.png);

3. 关于修改。    
    1.  可以在页面的onDestory里加入` mHandler.removeCallbacksAndMessages(null);`  

    2.  可以使用WeakReference,如：		

      ```java
          private static class MyHandler extends Handler {  
              private final WeakReference<HandlerActivity2> mActivity;  
        
              public MyHandler(HandlerActivity2 activity) {  
                  mActivity = new WeakReference<HandlerActivity2>(activity);  
              }  
        
              @Override  
              public void handleMessage(Message msg) {  
                  System.out.println(msg);  
                  if (mActivity.get() == null) {  
                      return;  
                  }  
                  mActivity.get().todo();  
              }  
          } 
      ```

      ​

    3. 可以使用封好的类。[badoo](https://github.com/badoo)/**[android-weak-handler](https://github.com/badoo/android-weak-handler)**,我对原项目进行了修改不依赖注解：**[WeakHandler](https://github.com/xuanu/Common/blob/master/library/src/main/java/common/zeffect/cn/library/aysnctask/WeakHandler.java)**